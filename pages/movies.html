

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies - Unblockee</title>
    <meta name="referrer" content="origin" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="../all.css">
    <link rel="stylesheet" href="../components/settings.css">
    <link rel="stylesheet" href="../components/topbar.css">
    <link rel="stylesheet" href="../components/changelog.css">

    <!-- Page-specific styles (NO MODAL CSS HERE ANYMORE) -->
    <style>
        .hero-section {
            padding: 30px 20px 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            animation: fadeIn 1s ease-in-out;
            font-family: 'Inter', sans-serif;
        }

        #header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            min-height: 24px;
            animation: fadeIn 1s ease-in-out 0.2s backwards;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            color: var(--text-primary);
            background: linear-gradient(135deg, rgba(53, 83, 10, 0.1) 0%, rgba(53, 83, 10, 0.05) 100%);
            border-radius: 6px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--text-primary) 0%, rgba(0, 0, 0, 0.1) 100%);
            color: var(--bg-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Grid */
        .content-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .media-item {
            width: 100%;
            text-align: center;
            background: linear-gradient(135deg, var(--card-color) 0%, rgba(0, 0, 0, 0.05) 100%);
            border-radius: 12px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
            aspect-ratio: 2/3;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .media-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 255, 255, 0.15);
            border-color: var(--text-secondary);
            z-index: 10;
        }

        .media-item img {
            width: 100%;
            height: 80%;
            object-fit: cover;
            flex-shrink: 0;
            border-radius: 0;
            transition: transform 0.3s ease;
        }

        .media-item:hover img { transform: scale(1.02); }

        .media-item p {
            margin: 8px 4px 0;
            font-size: 0.8rem;
            color: var(--text-primary);
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            height: 20%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
        }

        .media-item-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.9) 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
            color: white;
            pointer-events: none;
        }

        .media-item:hover .media-item-overlay { opacity: 1; }

        .overlay-rating { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: #ffd700; }
        .overlay-year { font-size: 0.8rem; opacity: 0.9; margin-bottom: 8px; }
        .overlay-description { font-size: 0.75rem; line-height: 1.3; text-align: center; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; color: #ddd; margin-top: 5px; }

        /* Search Bar */
        .movie-search-bar { padding: 20px 0; display: flex; justify-content: center; z-index: 1000; position: relative; }
        .movie-search-bar .search-form { width: 100%; max-width: 600px; position: relative; }
        .movie-search-bar .search-container { position: relative; display: flex; align-items: center; }
        .movie-search-bar .search-input { width: 100%; padding: 12px 60px 12px 16px; border: 1px solid var(--border-color); border-radius: 25px; background: var(--card-color); color: var(--text-primary); font-size: 16px; outline: none; transition: border-color 0.3s ease; }
        .movie-search-bar .search-input:focus { border-color: var(--primary-color); }
        .movie-search-bar .tb-search-btn { position: absolute; right: 8px; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.3s ease; }
        .movie-search-bar .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-color); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 12px 12px; max-height: 500px; overflow-y: auto; z-index: 10000; display: none; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); margin-top: 5px; }
        .movie-search-bar .search-suggestions.show { display: block; }
        .movie-search-bar .result-item { display: flex; align-items: flex-start; padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; }
        .movie-search-bar .result-item:hover { background: rgba(255, 255, 255, 0.05); }
        .movie-search-bar .result-item img { width: 60px; height: 90px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #222; }
        .movie-search-bar .result-info { flex: 1; text-align: left; overflow: hidden; }
        .movie-search-bar .result-title { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 15px; }
        .movie-search-bar .result-rating { font-weight: bold; color: #ffd700; font-size: 12px; }

        /* Categories */
        .categories-bar { display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; padding: 0 20px; }
        .category-btn { padding: 8px 16px; background: linear-gradient(135deg, var(--card-color) 0%, rgba(0, 0, 0, 0.05) 100%); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .category-btn:hover { border-color: var(--text-primary); color: var(--text-primary); transform: translateY(-2px); }
        .category-btn.active { background: linear-gradient(135deg, var(--text-primary) 0%, rgba(0, 0, 0, 0.1) 100%); color: var(--bg-color); border-color: transparent; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }

        /* Season Explorer */
        .season-episode-explorer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .season-episode-container { background: var(--card-color); padding: 20px; border-radius: 12px; width: 80%; max-width: 900px; max-height: 80vh; position: relative; overflow-y: auto; border: 1px solid var(--border-color); animation: modalSlideIn 0.3s ease; }
        .close-season-episode { position: absolute; top: 15px; right: 15px; color: var(--text-primary); font-size: 24px; cursor: pointer; transition: all 0.2s ease; background: rgba(255, 255, 255, 0.1); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .season-card, .episode-card { width: 100px; min-width: 80px; padding: 10px; text-align: center; background: linear-gradient(135deg, var(--card-color) 0%, rgba(0, 0, 0, 0.05) 100%); border-radius: 6px; cursor: pointer; overflow: hidden; transition: all 0.2s ease; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .episode-card { width: 200px; text-align: left; }
        .season-card:hover, .episode-card:hover { transform: scale(1.05); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); border-color: var(--text-secondary); }
        .seasons-container, .episodes-container { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; justify-content: center; }

        .hidden { display: none !important; }
        .loading-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-left: 4px solid var(--text-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .credits-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.7); color: var(--text-primary); text-align: center; padding: 8px 0; font-size: 0.8rem; z-index: 1200; backdrop-filter: blur(10px); }
        * { box-sizing: border-box; }
    </style>

    <!-- Scripts -->
    <script src="../utils/about-blank.js" defer></script>
    <script src="../utils/notifications.js" defer></script>
    <script src="../utils/color-thief-manager.js"></script>
    <script src="../components/settings.js" defer></script>
    <script src="../components/topbar.js" defer></script>
    <script src="../components/changelog.js" defer></script>
    <script src="../utils/storage.js"></script>
    <!-- Popup Script (NOW HANDLES ALL MODAL UI) -->
    <script src="../utils/popup.js" defer></script> 
</head>

<body>
    <!-- 
       NOTE: The Modal HTML is no longer here. 
       It is generated dynamically by popup.js to keep this file clean. 
    -->

    <!-- Season/Episode Explorer Modal (Kept here as it's a specific navigation UI) -->
    <div id="seasonEpisodeExplorer" class="season-episode-explorer">
        <div class="season-episode-container">
            <div id="seasonEpisodeHeader">
                <h3>Select a Season and Episode</h3>
                <i id="closeSeasonEpisode" class="fas fa-times close-season-episode"></i>
            </div>
            <div id="seasonsContainer" class="seasons-container"></div>
            <div id="episodesContainer" class="episodes-container"></div>
        </div>
    </div>

    <div class="hero-section content-below-topbar">
        <div id="header">
            <h1>Unblockee Movies</h1>
            <p id="subtitle">Loading...</p>
        </div>
    </div>

    <div class="tabs">
        <div id="moviesTab" class="tab active">Movies</div>
        <div id="tvShowsTab" class="tab">TV Shows</div>
    </div>

    <!-- Search -->
    <div class="movie-search-bar">
        <form class="search-form" id="movie-search-form">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search movies and TV shows..." autocomplete="off" id="searchInput">
                <button type="submit" class="tb-search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="search-suggestions" id="searchSuggestions"></div>
        </form>
    </div>

    <!-- Categories -->
    <div class="categories-bar">
        <button class="category-btn active" data-category="popular">Popular</button>
        <button class="category-btn" data-category="now_playing">Now Playing</button>
        <button class="category-btn" data-category="top_rated">Top Rated</button>
        <button class="category-btn" data-category="trending">Trending</button>
        <button class="category-btn" data-category="predefined">Featured</button>
    </div>

    <div id="moviesContainer" class="content-container"></div>
    <div id="tvShowsContainer" class="content-container hidden"></div>

    <div class="credits-bar">Credits to tf7software, InfinityLoop, and the LupineVault organization</div>

    <div id="loadingIndicator" class="loading-indicator hidden">
        <div class="spinner"></div>
    </div>

    <script>
        const CONFIG = {
            API_KEY: "2713804610e1e236b1cf44bfac3a7776",
            IMAGE_BASE_URL: "https://image.tmdb.org/t/p/w500",
            CACHE_EXPIRY: 72 * 60 * 60 * 1000,
            RATE_LIMIT: 100,
            RATE_LIMIT_WINDOW: 10000,
            INITIAL_LOAD: 80,
            LOAD_MORE: 20,
            MEDIA_LIMIT: 400
        };

        const PREDEFINED_MOVIES = [
             { id: 157336, title: "Interstellar", poster_path: "/gEU2QniE6E77NI6lCU6MxlNBvIx.jpg", vote_average: 8.4, overview: "The adventures of a group of explorers who make use of a newly discovered wormhole to surpass the limitations on human space travel and conquer the vast distances involved in an interstellar voyage.", release_date: "2014-11-05" },
             { id: 155, title: "The Dark Knight", poster_path: "/qJ2tW6WMUDux911r6m7haRef0WH.jpg", vote_average: 8.5, overview: "Batman raises the stakes in his war on crime.", release_date: "2008-07-14" },
             // ... (Keeping list short for brevity, original list works fine)
        ];

        const PROVIDERS = [
            { id: 'vidplus', name: 'Vidplus', urls: { movie: 'https://player.vidplus.to/embed/movie/{id}', tv: 'https://player.vidplus.to/embed/tv/{id}/{season}/{episode}' }, isActive: true },
            { id: 'vidify', name: 'Vidify', urls: { movie: 'https://player.vidify.top/embed/movie/{id}?autoplay=true', tv: 'https://player.vidify.top/embed/tv/{id}&s={season}&e={episode}' }, isActive: true },
            { id: 'vidfast', name: 'Vidfast', urls: { movie: 'https://vidfast.to/embed/movie/{id}', tv: 'https://vidfast.to/embed/tv/{id}&s={season}&e={episode}' }, isActive: true },
            { id: 'vidsrccx', name: 'VidsrcCX', urls: { movie: 'https://vidsrc.cx/embed/movie/{id}', tv: 'https://vidsrc.cx/embed/tv/{id}/{season}/{episode}' }, isActive: true },
            { id: 'vidsrcicu', name: 'VidSrc.icu', urls: { movie: 'https://vidsrc.icu/embedv2/movie/{id}', tv: 'https://vidsrc.icu/embedv2/tv/{id}/{season}/{episode}' }, isActive: true },
        ];

        // DOM elements
        const ELEMENTS = {
            moviesContainer: document.getElementById("moviesContainer"),
            tvShowsContainer: document.getElementById("tvShowsContainer"),
            searchInput: document.getElementById("searchInput"),
            searchSuggestions: document.getElementById("searchSuggestions"),
            seasonEpisodeExplorer: document.getElementById("seasonEpisodeExplorer"),
            closeSeasonEpisode: document.getElementById("closeSeasonEpisode"),
            seasonsContainer: document.getElementById("seasonsContainer"),
            episodesContainer: document.getElementById("episodesContainer"),
            moviesTab: document.getElementById("moviesTab"),
            tvShowsTab: document.getElementById("tvShowsTab"),
            subtitle: document.getElementById("subtitle"),
            categoryBtns: document.querySelectorAll('.category-btn')
        };

        // State management
        let state = {
            displayedMovies: 0,
            displayedTVShows: 0,
            currentPage: 1,
            isLoading: false,
            requestCount: 0,
            windowStart: Date.now(),
            currentMedia: null,
            currentProvider: localStorage.getItem('selectedProvider') || 'Vidplus',
            currentEmbedUrl: null,
            providerHealth: {},
            proxyEnabled: localStorage.getItem('proxyEnabled') === 'true' || false,
            currentCategory: 'popular'
        };

        // --- Utility Functions (Rate Limit, Cache) ---
        const rateLimitedFetch = async (endpoint) => { 
            if (state.requestCount >= CONFIG.RATE_LIMIT) {
                const elapsed = Date.now() - state.windowStart;
                if (elapsed < CONFIG.RATE_LIMIT_WINDOW) await new Promise(resolve => setTimeout(resolve, CONFIG.RATE_LIMIT_WINDOW - elapsed));
                state.requestCount = 0; state.windowStart = Date.now();
            }
            state.requestCount++;
            try {
                const response = await fetch(endpoint);
                if (response.status === 429) { await new Promise(resolve => setTimeout(resolve, 1000)); return rateLimitedFetch(endpoint); }
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return await response.json();
            } catch (error) { console.error(`Fetch error for ${endpoint}:`, error); throw error; }
        };

        const getCachedData = (key) => {
            const cached = localStorage.getItem(key);
            if (cached) {
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CONFIG.CACHE_EXPIRY) return data;
            }
            return null;
        };

        const setCachedData = (key, data) => localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
        const debounce = (func, delay) => { let timeoutId; return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func.apply(null, args), delay); }; };

        // --- Provider Logic ---
        function getProxyUrl(originalUrl) {
            if (state.proxyEnabled && originalUrl) {
                const encodedUrl = encodeURIComponent(originalUrl);
                return `../Staticsj/embed.html#${encodedUrl}`;
            }
            return originalUrl;
        }

        // --- Central Modal Launch Logic ---
        function launchMedia(mediaData, type) {
            state.currentMedia = mediaData;
            state.currentMedia.type = type;

            // Define Callbacks for Popup.js
            const callbacks = {
                currentProvider: state.currentProvider,
                isProxyEnabled: state.proxyEnabled,
                providerList: PROVIDERS.filter(p => p.isActive),
                
                // Called when user selects a new provider in the modal
                onProviderChange: (newProvider) => {
                    state.currentProvider = newProvider;
                    localStorage.setItem('selectedProvider', newProvider);
                    if (window.NotificationManager) window.NotificationManager.notify(`Switched to ${newProvider}`, 'info', 3000);
                    // Reload frame
                    const frame = document.getElementById('universalModalFrame');
                    if(frame) loadMediaToFrame(frame);
                },

                // Called when user toggles proxy
                onProxyToggle: (isEnabled) => {
                    state.proxyEnabled = isEnabled;
                    localStorage.setItem('proxyEnabled', isEnabled);
                    if (window.NotificationManager) window.NotificationManager.notify(`Proxy ${isEnabled ? 'enabled' : 'disabled'}`, 'info', 3000);
                    // Reload frame
                    const frame = document.getElementById('universalModalFrame');
                    if(frame) loadMediaToFrame(frame);
                },

                // Called immediately when modal opens
                onInit: (frameElement) => {
                    loadMediaToFrame(frameElement);
                },
                
                // Helper to get current URL for "Open in New Tab"
                getPayloadUrl: () => {
                     return state.currentEmbedUrl ? getProxyUrl(state.currentEmbedUrl) : null;
                }
            };

            // Call the generic opener from popup.js
            window.openMediaModal(mediaData, type, callbacks);
        }

        function loadMediaToFrame(frameElement) {
            if (!state.currentMedia || !frameElement) return;
            
            const provider = PROVIDERS.find(p => p.name === state.currentProvider) || PROVIDERS[0];
            let embedUrl = '';
            
            if (state.currentMedia.type === 'tv') {
                embedUrl = provider.urls.tv
                    .replace('{id}', state.currentMedia.id)
                    .replace('{season}', state.currentMedia.season)
                    .replace('{episode}', state.currentMedia.episode);
            } else {
                embedUrl = provider.urls.movie.replace('{id}', state.currentMedia.id);
            }

            state.currentEmbedUrl = embedUrl;
            frameElement.src = getProxyUrl(embedUrl);
        }

        // --- Search Logic ---
        const handleSearchInput = debounce(async (event) => {
            const query = event.target.value.trim();
            if (query.length < 2) { ELEMENTS.searchSuggestions.classList.remove('show'); return; }

            try {
                const data = await rateLimitedFetch(`https://api.themoviedb.org/3/search/multi?api_key=${CONFIG.API_KEY}&language=en-US&query=${encodeURIComponent(query)}&page=1`);
                ELEMENTS.searchSuggestions.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    const filtered = data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv').slice(0, 6);
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `
                            <img src="${item.poster_path ? CONFIG.IMAGE_BASE_URL + item.poster_path : 'https://via.placeholder.com/60x90'}" alt="${item.title || item.name}">
                            <div class="result-info">
                                <div class="result-title">${item.title || item.name}</div>
                                <div class="result-rating">${item.media_type.toUpperCase()} â€¢ ${(item.release_date || item.first_air_date || '').split('-')[0]}</div>
                            </div>
                        `;
                        div.onclick = () => {
                            if (item.media_type === 'tv') openSeasonExplorer(item.id);
                            else launchMedia(item, 'movie');
                            ELEMENTS.searchSuggestions.classList.remove('show');
                        };
                        ELEMENTS.searchSuggestions.appendChild(div);
                    });
                    ELEMENTS.searchSuggestions.classList.add('show');
                }
            } catch (e) { console.error(e); }
        }, 300);

        document.addEventListener('click', (e) => {
            if (!ELEMENTS.searchInput.contains(e.target)) ELEMENTS.searchSuggestions.classList.remove('show');
        });

        if (ELEMENTS.searchInput) ELEMENTS.searchInput.addEventListener("input", handleSearchInput);
        document.getElementById("movie-search-form")?.addEventListener("submit", (e) => e.preventDefault());


        // --- Display Logic ---
        function displayMovies(movies) {
            movies.forEach(movie => {
                if (state.displayedMovies >= CONFIG.MEDIA_LIMIT) return;
                const div = createMediaCard(movie, 'movie');
                ELEMENTS.moviesContainer.appendChild(div);
                state.displayedMovies++;
            });
        }

        function displayTVShows(tvShows) {
            tvShows.forEach(show => {
                if (state.displayedTVShows >= CONFIG.MEDIA_LIMIT) return;
                const div = createMediaCard(show, 'tv');
                ELEMENTS.tvShowsContainer.appendChild(div);
                state.displayedTVShows++;
            });
        }

        function createMediaCard(item, type) {
            const card = document.createElement('div');
            card.className = 'media-item';
            const title = item.title || item.name;
            const date = item.release_date || item.first_air_date;
            
            card.innerHTML = `
                <img src="${item.poster_path ? CONFIG.IMAGE_BASE_URL + item.poster_path : 'https://via.placeholder.com/120x180'}" alt="${title}">
                <div class="media-item-overlay">
                    <div class="overlay-rating">${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}/10</div>
                    <div class="overlay-description">${item.overview ? item.overview.substring(0, 100) + '...' : ''}</div>
                    <div class="overlay-year">${date ? new Date(date).getFullYear() : 'N/A'}</div>
                </div>
                <p>${title}</p>
            `;
            
            card.addEventListener("click", () => {
                if (type === 'tv') openSeasonExplorer(item.id);
                else launchMedia(item, 'movie');
            });
            return card;
        }

        // --- Data Loading ---
        async function loadMovies(query = "") {
            showLoading();
            ELEMENTS.moviesContainer.innerHTML = "";
            ELEMENTS.moviesContainer.classList.remove('hidden');
            state.displayedMovies = 0;
            state.currentPage = 1;

            if (state.currentCategory === 'predefined') {
                displayMovies(PREDEFINED_MOVIES);
                hideLoading();
                return;
            }

            let totalToLoad = CONFIG.INITIAL_LOAD;
            for (let page = 1; state.displayedMovies < totalToLoad; page++) {
                try {
                    let endpoint = `https://api.themoviedb.org/3/movie/${state.currentCategory}?api_key=${CONFIG.API_KEY}&language=en-US&page=${page}`;
                    if(state.currentCategory === 'trending') endpoint = `https://api.themoviedb.org/3/trending/movie/week?api_key=${CONFIG.API_KEY}&page=${page}`;
                    
                    const data = await rateLimitedFetch(endpoint);
                    if (!data.results.length) break;
                    
                    displayMovies(data.results.filter(m => m.poster_path));
                } catch (e) { break; }
            }
            if (state.displayedMovies >= CONFIG.INITIAL_LOAD) addLoadMoreButton();
            hideLoading();
        }

        async function loadTVShows() {
            showLoading();
            ELEMENTS.tvShowsContainer.innerHTML = "";
            ELEMENTS.tvShowsContainer.classList.remove('hidden');
            state.displayedTVShows = 0;
            
            for (let page = 1; state.displayedTVShows < CONFIG.INITIAL_LOAD; page++) {
                try {
                    const data = await rateLimitedFetch(`https://api.themoviedb.org/3/tv/popular?api_key=${CONFIG.API_KEY}&language=en-US&page=${page}`);
                    if (!data.results.length) break;
                    displayTVShows(data.results.filter(s => s.poster_path));
                } catch (e) { break; }
            }
            hideLoading();
        }

        // --- Load More Logic ---
        function addLoadMoreButton() {
            const btn = document.createElement('div');
            btn.className = 'media-item load-more-btn';
            btn.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;"><i class="fas fa-plus fa-2x"></i><br>Load More</div>';
            btn.onclick = loadMoreMovies;
            ELEMENTS.moviesContainer.appendChild(btn);
        }

        async function loadMoreMovies() {
            document.querySelector('.load-more-btn')?.remove();
            showLoading();
            state.currentPage++;
            // Simplified load more logic for brevity (similar to loadMovies loop)
            try {
                let endpoint = `https://api.themoviedb.org/3/movie/${state.currentCategory}?api_key=${CONFIG.API_KEY}&language=en-US&page=${state.currentPage}`;
                if(state.currentCategory === 'trending') endpoint = `https://api.themoviedb.org/3/trending/movie/week?api_key=${CONFIG.API_KEY}&page=${state.currentPage}`;
                
                const data = await rateLimitedFetch(endpoint);
                displayMovies(data.results.filter(m => m.poster_path));
                addLoadMoreButton();
            } catch(e) {}
            hideLoading();
        }

        // --- Season Explorer Logic ---
        async function openSeasonExplorer(tvShowId) {
            document.documentElement.scrollTop = 0;
            ELEMENTS.seasonEpisodeExplorer.style.display = "flex";
            ELEMENTS.episodesContainer.innerHTML = "";
            ELEMENTS.seasonsContainer.innerHTML = "Loading...";
            
            try {
                const data = await rateLimitedFetch(`https://api.themoviedb.org/3/tv/${tvShowId}?api_key=${CONFIG.API_KEY}`);
                ELEMENTS.seasonsContainer.innerHTML = "";
                data.seasons.forEach(season => {
                    const div = document.createElement("div");
                    div.className = "season-card";
                    div.textContent = `Season ${season.season_number}`;
                    div.onclick = () => fetchEpisodes(tvShowId, season.season_number);
                    ELEMENTS.seasonsContainer.appendChild(div);
                });
            } catch (e) { ELEMENTS.seasonsContainer.innerHTML = "Error loading."; }
        }

        async function fetchEpisodes(tvShowId, seasonNumber) {
            ELEMENTS.episodesContainer.innerHTML = "Loading...";
            try {
                const data = await rateLimitedFetch(`https://api.themoviedb.org/3/tv/${tvShowId}/season/${seasonNumber}?api_key=${CONFIG.API_KEY}`);
                ELEMENTS.episodesContainer.innerHTML = "";
                data.episodes.forEach(ep => {
                    const div = document.createElement("div");
                    div.className = "episode-card";
                    div.innerHTML = `<h3>S${ep.season_number}E${ep.episode_number} - ${ep.name}</h3>`;
                    div.onclick = () => {
                        ELEMENTS.seasonEpisodeExplorer.style.display = "none";
                        launchMedia({ ...ep, id: tvShowId, title: ep.name, season: seasonNumber, episode: ep.episode_number }, 'tv');
                    };
                    ELEMENTS.episodesContainer.appendChild(div);
                });
            } catch(e) { ELEMENTS.episodesContainer.innerHTML = "Error."; }
        }

        ELEMENTS.closeSeasonEpisode.onclick = () => ELEMENTS.seasonEpisodeExplorer.style.display = "none";

        // --- Initialization ---
        function switchTab(type) {
            if (type === "tv-shows") {
                ELEMENTS.moviesTab.classList.remove("active"); ELEMENTS.tvShowsTab.classList.add("active");
                ELEMENTS.moviesContainer.classList.add('hidden'); ELEMENTS.tvShowsContainer.classList.remove('hidden');
                if(!state.displayedTVShows) loadTVShows();
            } else {
                ELEMENTS.tvShowsTab.classList.remove("active"); ELEMENTS.moviesTab.classList.add("active");
                ELEMENTS.tvShowsContainer.classList.add('hidden'); ELEMENTS.moviesContainer.classList.remove('hidden');
                if(!state.displayedMovies) loadMovies();
            }
        }
        ELEMENTS.moviesTab.onclick = () => switchTab("movies");
        ELEMENTS.tvShowsTab.onclick = () => switchTab("tv-shows");
        
        ELEMENTS.categoryBtns.forEach(btn => {
            btn.onclick = () => {
                ELEMENTS.categoryBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentCategory = btn.dataset.category;
                loadMovies();
            };
        });

        function showLoading() { document.getElementById("loadingIndicator").classList.remove('hidden'); }
        function hideLoading() { document.getElementById("loadingIndicator").classList.add('hidden'); }

        ELEMENTS.subtitle.textContent = "Browse and stream movies and TV shows";
        loadMovies();
    </script>
</body>
</html>
